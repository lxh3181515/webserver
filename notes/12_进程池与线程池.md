# 进程池与线程池

通过动态创建子进程（或子线程）来实现并发服务器，存在以下缺点：

- 创建耗时，导致较慢的客户响应
- 通常一个子进程（或子线程）只服务一个客户，将导致系统产生大量的进程（或线程）。进程（或线程）间切换消耗大量CPU时间。
- 动态创建子进程是当前进程的完整映像。必须谨慎管理文件描述符和堆内存等系统资源，否则可能会由于资源的复制导致性能下降。

## 概述

进程池和线程池相似，以进程池为例。

进程池是服务器预先创建的一组子进程，一般情况子进程数目在3~10之间。

进程池中的所有子进程都运行着相同的代码，并且具有相同属性，例如优先级、PGID等。由于预先创建好了，每个子进程都相对“干净”，即没有打开不必要的文件描述符或错误使用大块堆内存。

**任务分配**

当有新任务到来，主进程选择一个子进程来服务，选择方式有两种：
- 通过某种算法主动选择。最简单常用的随机和Round Robin（轮流选取），更好的算法使各个进程工作均匀分配。
- 通过共享的工作队列同步。当有新任务到来，主进程将任务添加到工作队列，唤醒正在等待任务的子进程，只有一个子进程接管任务，其他子进程则继续睡眠。

**任务交接**

选好子进程后，主进程还需使用某种通知机制告知子进程，并传递必要数据。

最简单的方法是，预先建立一条管道，通过管道实现进程间的通信。线程之间的数据传递则简单得多，因为可以把数据定义为全局。
